<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民視政治組排班表</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Maps to manage dependencies -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
      }
    }
    </script>

    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Trash2, Users, Cloud, CloudOff, Calendar, Lock, Unlock, X, Check, AlertTriangle, Settings, Plus, Minus, GripVertical, ChevronUp, ChevronDown, Clock, Info, Plane } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from 'firebase/firestore';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4",
            authDomain: "fuktrip.firebaseapp.com",
            projectId: "fuktrip",
            storageBucket: "fuktrip.firebasestorage.app",
            messagingSenderId: "663462561018",
            appId: "1:663462561018:web:d0c9f00c9fed0253a2b543",
            measurementId: "G-KME94X3EKH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Use a fixed global ID for this specific app instance to share data
        const APP_ID = 'political-schedule-v1'; 
        const COLLECTION_NAME = 'schedules';
        const DOC_ID = 'main';

        // --- UI Components ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-gray-50">
                            <h3 className="font-bold text-gray-700">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const PoliticalGroupSchedule = () => {
            // --- State Definitions ---
            
            // 1. 人員名單 (預設名單)
            const DEFAULT_STAFF = [
                '陳妍伶', '吳承翰', '林靜', '林秀宜', '楊凱安', '林彥君', '屈道昀', '王云宣'
            ];
            const [staffList, setStaffList] = useState(DEFAULT_STAFF);

            // 選項定義 (包含休播，特休改回年)
            const OPTIONS = ['', '休', '夜', '休播', '年', '補', 'X'];

            // 2. 時間與使用者狀態
            const today = new Date();
            // 計算下個月
            const nextMonthDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            
            const [year, setYear] = useState(nextMonthDate.getFullYear());
            const [month, setMonth] = useState(nextMonthDate.getMonth() + 1);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, saved, error
            const [lastUpdated, setLastUpdated] = useState(null); // 最後更新時間
            
            // Modals State
            const [showUnlockModal, setShowUnlockModal] = useState(false);
            const [unlockPassword, setUnlockPassword] = useState('');
            const [unlockError, setUnlockError] = useState('');
            const [showClearModal, setShowClearModal] = useState(false);
            const [showHelpModal, setShowHelpModal] = useState(false);
            
            // Staff Management Modals
            const [showStaffAuthModal, setShowStaffAuthModal] = useState(false);
            const [showStaffManagerModal, setShowStaffManagerModal] = useState(false);
            const [staffAuthPassword, setStaffAuthPassword] = useState('');
            const [staffAuthError, setStaffAuthError] = useState('');
            const [newStaffName, setNewStaffName] = useState('');
            
            // Overseas Modal
            const [showOverseasModal, setShowOverseasModal] = useState(false);
            const [overseasPerson, setOverseasPerson] = useState('');
            const [overseasStartDate, setOverseasStartDate] = useState('');
            const [overseasEndDate, setOverseasEndDate] = useState('');
            
            // Drag and Drop State
            const [draggedIndex, setDraggedIndex] = useState(null);

            // Member Lock State
            const [memberLocks, setMemberLocks] = useState({});
            const [showMemberLockModal, setShowMemberLockModal] = useState(false);
            const [targetMember, setTargetMember] = useState(null);
            const [memberLockPassword, setMemberLockPassword] = useState('');
            const [isSettingLock, setIsSettingLock] = useState(false); 

            // 3. 資料狀態 (從 Firebase 讀取)
            const [scheduleData, setScheduleData] = useState({});
            const [requirements, setRequirements] = useState({}); 
            const [darkenedDays, setDarkenedDays] = useState({});
            // Overseas Data Map { "YYYY-M-D-Person": true }
            const [overseasData, setOverseasData] = useState({});
            
            const [lockedMonths, setLockedMonths] = useState({}); 
            const [deadlines, setDeadlines] = useState({});
            const [shouldLeaveDaysMap, setShouldLeaveDaysMap] = useState({});
            const [actualLeaveDaysMap, setActualLeaveDaysMap] = useState({});

            // --- Derived State (Current Month) ---
            const currentMonthKey = `${year}-${month}`;
            const isLocked = lockedMonths[currentMonthKey] || false;
            const currentDeadline = deadlines[currentMonthKey] || '';
            const currentShouldLeave = shouldLeaveDaysMap[currentMonthKey] || '';
            const currentActualLeave = actualLeaveDaysMap[currentMonthKey] || '';

            // --- Firebase Logic ---

            // Auth Initialization
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth error:", error);
                        setSyncStatus('error');
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            // Data Synchronization (Real-time listener)
            useEffect(() => {
                if (!user) return;

                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', COLLECTION_NAME, DOC_ID);

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    setLoading(false);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setScheduleData(data.schedule || {});
                        setRequirements(data.requirements || {});
                        setDarkenedDays(data.darkenedDays || {});
                        setOverseasData(data.overseasData || {});
                        
                        setLockedMonths(data.lockedMonths || {});
                        setDeadlines(data.deadlines || {});
                        setShouldLeaveDaysMap(data.shouldLeaveDaysMap || {});
                        setActualLeaveDaysMap(data.actualLeaveDaysMap || {});
                        
                        setMemberLocks(data.memberLocks || {});
                        setLastUpdated(data.lastUpdated || null);

                        if (data.staffList && Array.isArray(data.staffList) && data.staffList.length > 0) {
                            if (data.staffList[0] === '徐葳倫') {
                                console.log("Detected Mirror TV staff list, reverting to Political Group default...");
                                setStaffList(DEFAULT_STAFF);
                                updateDoc(docRef, { staffList: DEFAULT_STAFF }).catch(err => console.error("Revert failed", err));
                            } else {
                                setStaffList(data.staffList);
                            }
                        } else {
                            setStaffList(DEFAULT_STAFF);
                        }

                        setSyncStatus('saved');
                    } else {
                        const initialData = { 
                            schedule: {}, 
                            requirements: {},
                            darkenedDays: {},
                            overseasData: {},
                            lockedMonths: {},
                            deadlines: {},
                            shouldLeaveDaysMap: {},
                            actualLeaveDaysMap: {},
                            staffList: DEFAULT_STAFF,
                            memberLocks: {},
                            lastUpdated: new Date().toISOString()
                        };
                        setDoc(docRef, initialData).catch(e => {
                            console.error("Init doc error:", e);
                            setSyncStatus('error');
                        });
                    }
                }, (error) => {
                    console.error("Snapshot error:", error);
                    setSyncStatus('error');
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // Generic Save Helper
            const saveToFirebase = async (updates) => {
                if (!user) return;
                setSyncStatus('syncing');
                try {
                    const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', COLLECTION_NAME, DOC_ID);
                    const updatesWithTimestamp = {
                        ...updates,
                        lastUpdated: new Date().toISOString()
                    };
                    await updateDoc(docRef, updatesWithTimestamp);
                    setSyncStatus('saved');
                } catch (error) {
                    console.error("Save error:", error);
                    setSyncStatus('error');
                }
            };

            // --- Handlers ---

            const handleToggleLock = () => {
                if (isLocked) {
                    setUnlockPassword('');
                    setUnlockError('');
                    setShowUnlockModal(true);
                } else {
                    const newLockedMonths = { ...lockedMonths, [currentMonthKey]: true };
                    setLockedMonths(newLockedMonths);
                    saveToFirebase({ lockedMonths: newLockedMonths });
                }
            };

            const confirmUnlock = () => {
                if (unlockPassword === "123456") {
                    const newLockedMonths = { ...lockedMonths };
                    delete newLockedMonths[currentMonthKey];
                    setLockedMonths(newLockedMonths);
                    saveToFirebase({ lockedMonths: newLockedMonths });
                    setShowUnlockModal(false);
                } else {
                    setUnlockError("密碼錯誤，請重試");
                }
            };

            // --- Member Lock Handlers ---
            const handleMemberLockClick = (person) => {
                const lockInfo = memberLocks[person];
                setTargetMember(person);
                setMemberLockPassword('');
                setUnlockError('');
                
                if (lockInfo && lockInfo.isLocked) {
                    setIsSettingLock(false);
                } else {
                    setIsSettingLock(true);
                }
                setShowMemberLockModal(true);
            };

            const confirmMemberLockAction = () => {
                if (!targetMember) return;

                if (isSettingLock) {
                    if (!memberLockPassword) {
                        setUnlockError("請設定密碼");
                        return;
                    }
                    const newLocks = {
                        ...memberLocks,
                        [targetMember]: { isLocked: true, password: memberLockPassword }
                    };
                    setMemberLocks(newLocks);
                    saveToFirebase({ memberLocks: newLocks });
                    setShowMemberLockModal(false);
                } else {
                    const lockInfo = memberLocks[targetMember];
                    if (memberLockPassword === lockInfo.password || memberLockPassword === "123456") {
                        const newLocks = { ...memberLocks };
                        delete newLocks[targetMember];
                        setMemberLocks(newLocks);
                        saveToFirebase({ memberLocks: newLocks });
                        setShowMemberLockModal(false);
                    } else {
                        setUnlockError("密碼錯誤");
                    }
                }
            };

            // --- Overseas Handlers ---
            const openOverseasModal = () => {
                setOverseasPerson(staffList[0]);
                const todayStr = new Date().toISOString().split('T')[0];
                setOverseasStartDate(todayStr);
                setOverseasEndDate(todayStr);
                setShowOverseasModal(true);
            };

            const handleSaveOverseas = (isAdding) => {
                if (!overseasPerson || !overseasStartDate || !overseasEndDate) return;

                const start = new Date(overseasStartDate);
                const end = new Date(overseasEndDate);
                const newOverseasData = { ...overseasData };

                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const y = d.getFullYear();
                    const m = d.getMonth() + 1;
                    const day = d.getDate();
                    const key = `${y}-${m}-${day}-${overseasPerson}`;
                    
                    if (isAdding) {
                        newOverseasData[key] = true;
                    } else {
                        delete newOverseasData[key];
                    }
                }

                setOverseasData(newOverseasData);
                saveToFirebase({ overseasData: newOverseasData });
                setShowOverseasModal(false);
            };

            // --- Staff Management Handlers ---
            const openStaffSettings = () => {
                setStaffAuthPassword('');
                setStaffAuthError('');
                setShowStaffAuthModal(true);
            };

            const confirmStaffAuth = () => {
                if (staffAuthPassword === "123456") {
                    setShowStaffAuthModal(false);
                    setShowStaffManagerModal(true);
                } else {
                    setStaffAuthError("密碼錯誤，請重試");
                }
            };

            const handleAddStaff = () => {
                if (newStaffName.trim()) {
                    const newList = [...staffList, newStaffName.trim()];
                    setStaffList(newList);
                    setNewStaffName('');
                    saveToFirebase({ staffList: newList });
                }
            };

            const handleRemoveStaff = (index) => {
                const newList = [...staffList];
                newList.splice(index, 1);
                setStaffList(newList);
                saveToFirebase({ staffList: newList });
            };

            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            };

            const handleDrop = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;

                const newStaffList = [...staffList];
                const draggedItem = newStaffList[draggedIndex];
                newStaffList.splice(draggedIndex, 1);
                newStaffList.splice(index, 0, draggedItem);

                setStaffList(newStaffList);
                setDraggedIndex(null);
                saveToFirebase({ staffList: newStaffList });
            };

            const handleInputChange = (person, day, value) => {
                if (isLocked) return;
                if (memberLocks[person]?.isLocked) {
                    alert(`「${person}」的班表已鎖定，請點擊前方鎖頭解鎖後再編輯。`);
                    return;
                }

                const key = `${year}-${month}-${person}-${day}`;
                const newData = { ...scheduleData, [key]: value };
                setScheduleData(newData);
                saveToFirebase({ schedule: newData });
            };

            const handleRequirementChange = (day, delta) => {
                if (isLocked) return;
                const key = `${year}-${month}-${day}`;
                const dateObj = new Date(year, month - 1, day);
                const dayOfWeek = dateObj.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const currentVal = requirements[key] !== undefined ? requirements[key] : (isWeekend ? 3 : 4);
                
                let newVal = currentVal + delta;
                if (newVal < 0) newVal = 0;
                if (newVal > 99) newVal = 99;

                const newReqs = { ...requirements, [key]: newVal };
                setRequirements(newReqs);
                saveToFirebase({ requirements: newReqs });
            };

            const handleMonthlyDataChange = (type, value) => {
                if (isLocked) return;
                
                if (type === 'deadline') {
                    const newDeadlines = { ...deadlines, [currentMonthKey]: value };
                    setDeadlines(newDeadlines);
                    saveToFirebase({ deadlines: newDeadlines });
                } else if (type === 'shouldLeave') {
                    const newMap = { ...shouldLeaveDaysMap, [currentMonthKey]: value };
                    setShouldLeaveDaysMap(newMap);
                    saveToFirebase({ shouldLeaveDaysMap: newMap });
                } else if (type === 'actualLeave') {
                    const newMap = { ...actualLeaveDaysMap, [currentMonthKey]: value };
                    setActualLeaveDaysMap(newMap);
                    saveToFirebase({ actualLeaveDaysMap: newMap });
                }
            };

            const handleToggleDarkenedDay = (dayDate) => {
                if (isLocked) return;
                const key = `${year}-${month}-${dayDate}`;
                const newStatus = !darkenedDays[key];
                const newDarkenedDays = { ...darkenedDays, [key]: newStatus };
                setDarkenedDays(newDarkenedDays);
                saveToFirebase({ darkenedDays: newDarkenedDays });
            };

            const handleClearMonth = () => {
                if (isLocked) return;
                setShowClearModal(true);
            };

            const confirmClearMonth = () => {
                const newData = { ...scheduleData };
                staffList.forEach(person => {
                    daysInMonth.forEach(day => {
                        const key = `${year}-${month}-${person}-${day.date}`;
                        delete newData[key];
                    });
                });
                setScheduleData(newData);
                saveToFirebase({ schedule: newData });
                setShowClearModal(false);
            };

            // --- Calculations ---

            const years = Array.from({ length: 11 }, (_, i) => today.getFullYear() - 5 + i);
            const months = Array.from({ length: 12 }, (_, i) => i + 1);

            const getRequiredStaff = (dayDate, isWeekend) => {
                const key = `${year}-${month}-${dayDate}`;
                if (requirements[key] !== undefined) {
                    return requirements[key];
                }
                return isWeekend ? 3 : 4; 
            };

            const daysInMonth = useMemo(() => {
                const date = new Date(year, month, 0);
                const daysCount = date.getDate();
                const daysArray = [];

                for (let i = 1; i <= daysCount; i++) {
                    const currentDay = new Date(year, month - 1, i);
                    const dayOfWeek = currentDay.getDay(); 
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    daysArray.push({
                        date: i,
                        dayOfWeek: dayOfWeek,
                        isWeekend: isWeekend,
                        dayName: ['日', '一', '二', '三', '四', '五', '六'][dayOfWeek]
                    });
                }
                return daysArray;
            }, [year, month]);

            const getValue = (person, day) => {
                if (!scheduleData) return '';
                const key = `${year}-${month}-${person}-${day}`;
                return scheduleData[key] || '';
            };

            // 計算某人本月已休天數 (休 + 休播)
            const getTakenLeaveCount = (person) => {
                return daysInMonth.reduce((count, day) => {
                    const val = getValue(person, day.date);
                    // 修正：計算 '休' 和 '休播'
                    return (val === '休' || val === '休播') ? count + 1 : count;
                }, 0);
            };

            const getWorkingCount = (day) => {
                let count = 0;
                staffList.forEach(person => {
                    const val = getValue(person, day);
                    const isOverseas = overseasData[`${year}-${month}-${day}-${person}`];
                    // 如果出國，則不算上班。否則看是否為空白或X
                    if (!isOverseas && (val === '' || val === 'X')) {
                        count++;
                    }
                });
                return count;
            };

            const exportToCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += `月份: ${year}年${month}月, 截止日期: ${currentDeadline}, 應休天數: ${currentShouldLeave}, 實休天數: ${currentActualLeave}\n`;
                
                // Header: Name, Taken, Dates...
                let headerRow = ["人員", "已休", ...daysInMonth.map(d => `${d.date}(${d.dayName})`)];
                csvContent += headerRow.join(",") + "\n";

                staffList.forEach(person => {
                    const taken = getTakenLeaveCount(person);
                    let row = [person, taken];
                    daysInMonth.forEach(d => {
                        let val = getValue(person, d.date);
                        row.push(`"${val.replace(/"/g, '""')}"`); 
                    });
                    csvContent += row.join(",") + "\n";
                });

                let reqRow = ["需求人數", "", ...daysInMonth.map(d => getRequiredStaff(d.date, d.isWeekend))];
                csvContent += reqRow.join(",") + "\n";

                let statsRow = ["上班人數", "", ...daysInMonth.map(d => getWorkingCount(d.date))];
                csvContent += statsRow.join(",") + "\n";

                let availableRow = ["可休人數", "", ...daysInMonth.map(d => {
                    const count = getWorkingCount(d.date);
                    const req = getRequiredStaff(d.date, d.isWeekend);
                    return count - req;
                })];
                csvContent += availableRow.join(",") + "\n";

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `民視政治組排班表_${year}_${month}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const getSelectStyle = (value) => {
                let baseStyle = "w-full h-10 px-1 text-center bg-transparent border-none focus:ring-2 focus:ring-inset focus:ring-blue-500 text-sm appearance-none cursor-pointer font-bold ";
                if (isLocked) {
                    baseStyle = baseStyle.replace('cursor-pointer', 'cursor-not-allowed opacity-70');
                }
                if (value === '夜') return baseStyle + "text-amber-500"; 
                if (value === 'X') return baseStyle + "text-red-600";
                if (value) return baseStyle + "text-blue-600";
                return baseStyle + "text-gray-400 font-normal";
            };

            const formatLastUpdated = (isoString) => {
                if (!isoString) return "尚未有更新";
                const d = new Date(isoString);
                return d.toLocaleString('zh-TW', { hour12: false });
            };

            // Should Leave Limit
            const shouldLeaveLimit = parseInt(currentShouldLeave) || 0;

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col font-sans text-gray-800 relative">
                    {/* Header Section */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
                        <div className="max-w-full px-4 sm:px-6 lg:px-8 h-auto sm:h-16 py-2 sm:py-0 flex flex-col sm:flex-row items-center justify-between gap-3">
                            
                            {/* Logo & Title & Extra Info */}
                            <div className="flex flex-wrap items-center gap-3 w-full sm:w-auto justify-between sm:justify-start">
                                <div className="flex items-center gap-2">
                                    <div className="bg-blue-600 p-2 rounded-lg text-white">
                                        <Users size={20} />
                                    </div>
                                    <h1 className="text-xl font-bold tracking-tight text-gray-900 whitespace-nowrap">
                                        民視政治組排班表
                                    </h1>
                                </div>

                                {/* Staff Settings Button */}
                                <button
                                    onClick={openStaffSettings}
                                    className="p-1.5 rounded-md transition-colors border bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100"
                                    title="修改排班人員"
                                >
                                    <Settings size={16} />
                                </button>

                                {/* Overseas Button */}
                                <button
                                    onClick={openOverseasModal}
                                    className="p-1.5 rounded-md transition-colors border bg-pink-50 text-pink-600 border-pink-200 hover:bg-pink-100"
                                    title="預排出國日期"
                                >
                                    <Plane size={16} />
                                </button>

                                {/* Help Button */}
                                <button
                                    onClick={() => setShowHelpModal(true)}
                                    className="p-1.5 rounded-md transition-colors border bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100"
                                    title="使用說明"
                                >
                                    <Info size={16} />
                                </button>

                                {/* Lock/Unlock Button */}
                                <button
                                    onClick={handleToggleLock}
                                    className={`
                                        p-1.5 rounded-md transition-colors border
                                        ${isLocked 
                                            ? 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100' 
                                            : 'bg-green-50 text-green-600 border-green-200 hover:bg-green-100'
                                        }
                                    `}
                                    title={isLocked ? "解鎖本月" : "鎖定本月"}
                                >
                                    {isLocked ? <Lock size={16} /> : <Unlock size={16} />}
                                </button>

                                {/* Deadline Input (Shrunk) */}
                                <div className="flex items-center bg-red-50 border border-red-100 rounded px-2 py-1 ml-0 sm:ml-2">
                                    <span className="text-xs text-red-500 font-medium mr-1 whitespace-nowrap">截止:</span>
                                    <input 
                                        type="text" 
                                        disabled={isLocked}
                                        placeholder="日期" 
                                        value={currentDeadline}
                                        onChange={(e) => handleMonthlyDataChange('deadline', e.target.value)}
                                        className={`bg-transparent border-b border-red-200 text-sm text-red-700 w-16 focus:outline-none focus:border-red-400 placeholder-red-200 ${isLocked ? 'cursor-not-allowed opacity-60' : ''}`}
                                    />
                                </div>

                                {/* Should Leave Input */}
                                <div className="flex items-center bg-blue-50 border border-blue-100 rounded px-2 py-1 ml-0 sm:ml-1">
                                    <span className="text-xs text-blue-500 font-medium mr-1 whitespace-nowrap">應休:</span>
                                    <input 
                                        type="text" 
                                        disabled={isLocked}
                                        placeholder="天" 
                                        value={currentShouldLeave}
                                        onChange={(e) => handleMonthlyDataChange('shouldLeave', e.target.value)}
                                        className={`bg-transparent border-b border-blue-200 text-sm text-blue-700 w-8 sm:w-10 text-center focus:outline-none focus:border-blue-400 placeholder-blue-200 ${isLocked ? 'cursor-not-allowed opacity-60' : ''}`}
                                    />
                                </div>

                                {/* Actual Leave Input */}
                                <div className="flex items-center bg-green-50 border border-green-100 rounded px-2 py-1 ml-0 sm:ml-1">
                                    <span className="text-xs text-green-500 font-medium mr-1 whitespace-nowrap">實休:</span>
                                    <input 
                                        type="text" 
                                        disabled={isLocked}
                                        placeholder="天" 
                                        value={currentActualLeave}
                                        onChange={(e) => handleMonthlyDataChange('actualLeave', e.target.value)}
                                        className={`bg-transparent border-b border-green-200 text-sm text-green-700 w-8 sm:w-10 text-center focus:outline-none focus:border-green-400 placeholder-green-200 ${isLocked ? 'cursor-not-allowed opacity-60' : ''}`}
                                    />
                                </div>
                                
                                {/* Sync Status (Mobile) */}
                                <div className="sm:hidden ml-auto">
                                    {syncStatus === 'syncing' ? <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div> : 
                                    syncStatus === 'saved' ? <div className="w-2 h-2 bg-green-500 rounded-full"></div> : 
                                    <div className="w-2 h-2 bg-red-500 rounded-full"></div>}
                                </div>
                            </div>

                            {/* Controls */}
                            <div className="flex flex-wrap items-center justify-center gap-2 sm:gap-4 w-full sm:w-auto mt-2 sm:mt-0">
                                {/* Date Selectors */}
                                <div className="flex gap-2">
                                    <div className="flex items-center bg-gray-100 rounded-md p-1">
                                        <select 
                                            value={year} 
                                            onChange={(e) => setYear(Number(e.target.value))}
                                            className="bg-transparent border-none text-sm font-medium focus:ring-0 cursor-pointer py-1 pl-1 pr-6"
                                        >
                                            {years.map(y => <option key={y} value={y}>{y}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex items-center bg-gray-100 rounded-md p-1">
                                        <select 
                                            value={month} 
                                            onChange={(e) => setMonth(Number(e.target.value))}
                                            className="bg-transparent border-none text-sm font-medium focus:ring-0 cursor-pointer py-1 pl-1 pr-6"
                                        >
                                            {months.map(m => <option key={m} value={m}>{m}月</option>)}
                                        </select>
                                    </div>
                                </div>
                                
                                <div className="h-6 w-px bg-gray-300 hidden sm:block"></div>

                                {/* Action Buttons */}
                                <div className="flex gap-2">
                                    <button 
                                        onClick={exportToCSV}
                                        className="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 text-sm font-medium text-blue-700 hover:bg-blue-50 rounded-md transition-colors"
                                        title="匯出 CSV"
                                    >
                                        <Download size={16} />
                                        <span className="hidden sm:inline">匯出</span>
                                    </button>
                                    <button 
                                        onClick={handleClearMonth}
                                        disabled={isLocked}
                                        className={`flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                                            ${isLocked 
                                                ? 'text-gray-400 bg-gray-100 cursor-not-allowed' 
                                                : 'text-red-600 hover:bg-red-50'
                                            }
                                        `}
                                        title="清空本月"
                                    >
                                        <Trash2 size={16} />
                                        <span className="hidden sm:inline">清空</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content - Table */}
                    <main className="flex-1 overflow-hidden relative flex flex-col">
                        {loading ? (
                            <div className="flex-1 flex items-center justify-center text-gray-500 gap-2">
                                <Cloud className="animate-bounce" /> 載入資料中...
                            </div>
                        ) : (
                            <div className="flex-1 overflow-auto relative">
                                <table className="border-collapse w-full min-w-max text-sm">
                                    <thead className="bg-white z-20 sticky top-0 shadow-sm">
                                        <tr>
                                            {/* Name Header */}
                                            <th className="sticky left-0 top-0 z-30 bg-gray-100 border-b border-r border-gray-300 w-[120px] min-w-[120px] p-2 text-center font-bold text-gray-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                人員
                                            </th>
                                            {/* Taken Leave Header */}
                                            <th className="sticky left-[120px] top-0 z-30 bg-gray-100 border-b border-r border-gray-300 w-[60px] min-w-[60px] p-2 text-center font-bold text-gray-700 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)]">
                                                已休
                                            </th>
                                            
                                            {/* Date Headers */}
                                            {daysInMonth.map((day) => {
                                                const reqStaff = getRequiredStaff(day.date, day.isWeekend);
                                                const isDarkened = darkenedDays[`${year}-${month}-${day.date}`];
                                                
                                                return (
                                                    <th 
                                                        key={day.date} 
                                                        onDoubleClick={() => handleToggleDarkenedDay(day.date)}
                                                        className={`
                                                            border-b border-r border-gray-200 p-1 min-w-[50px] text-center transition-colors align-top select-none
                                                            ${isLocked ? 'cursor-default' : 'cursor-pointer'}
                                                            ${isDarkened 
                                                                ? 'bg-gray-600 text-white border-gray-500' 
                                                                : (day.isWeekend ? 'bg-orange-50 text-orange-800' : 'bg-white text-gray-600')
                                                            }
                                                        `}
                                                        title={isLocked ? "" : "雙擊切換深色標記"}
                                                    >
                                                        <div className="flex flex-col items-center py-1 gap-1">
                                                            <span className={`text-xs ${isDarkened ? 'opacity-90' : 'opacity-70'}`}>{day.dayName}</span>
                                                            <span className="font-bold text-lg leading-none">{day.date}</span>
                                                            {/* Arrow Controls for Requirement */}
                                                            <div className={`flex items-center justify-center mt-1 rounded-full px-1 gap-0.5 ${isDarkened ? 'bg-white/20' : 'bg-black/5'}`}>
                                                                <span className={`text-[9px] mr-0.5 ${isDarkened ? 'text-gray-200' : 'text-gray-500'}`}>需</span>
                                                                <span className={`text-[10px] font-bold w-3 text-center ${isDarkened ? 'text-white' : 'text-gray-800'}`}>{reqStaff}</span>
                                                                <div className="flex flex-col -my-1">
                                                                    <button 
                                                                        onClick={() => handleRequirementChange(day.date, 1)}
                                                                        disabled={isLocked}
                                                                        className={`p-0.5 hover:bg-black/10 rounded disabled:opacity-30 ${isDarkened ? 'text-white' : 'text-gray-600'}`}
                                                                    >
                                                                        <ChevronUp size={8} strokeWidth={4} />
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => handleRequirementChange(day.date, -1)}
                                                                        disabled={isLocked}
                                                                        className={`p-0.5 hover:bg-black/10 rounded disabled:opacity-30 ${isDarkened ? 'text-white' : 'text-gray-600'}`}
                                                                    >
                                                                        <ChevronDown size={8} strokeWidth={4} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </th>
                                                );
                                            })}
                                        </tr>
                                    </thead>
                                    
                                    <tbody>
                                        {/* Staff Rows */}
                                        {staffList.map((person, index) => {
                                            const lockInfo = memberLocks[person];
                                            const isMemberLocked = lockInfo?.isLocked;
                                            const takenLeave = getTakenLeaveCount(person);
                                            const isOverLimit = takenLeave > shouldLeaveLimit;

                                            return (
                                            <tr key={person} className="group hover:bg-gray-50">
                                                {/* Sticky Name Cell */}
                                                <td className="sticky left-0 z-10 bg-white group-hover:bg-gray-50 border-r border-b border-gray-300 font-medium text-gray-900 text-center shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] px-2">
                                                    <div className="flex items-center justify-between h-10 w-full">
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-6 h-6 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-xs font-bold select-none">
                                                                {person.charAt(0)}
                                                            </span>
                                                            <span className="text-sm">{person}</span>
                                                        </div>
                                                        <button 
                                                            onClick={() => handleMemberLockClick(person)}
                                                            className={`p-1 rounded-md transition-colors ml-1 ${isMemberLocked ? 'text-red-500 hover:bg-red-50' : 'text-gray-300 hover:text-gray-500 hover:bg-gray-100'}`}
                                                            title={isMemberLocked ? "已鎖定 (點擊解鎖)" : "未鎖定 (點擊上鎖)"}
                                                        >
                                                            {isMemberLocked ? <Lock size={12} /> : <Unlock size={12} />}
                                                        </button>
                                                    </div>
                                                </td>

                                                {/* Sticky Taken Leave Count Cell */}
                                                <td className={`sticky left-[120px] z-10 bg-white group-hover:bg-gray-50 border-r border-b border-gray-300 font-bold text-center shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)] ${isOverLimit ? 'text-red-600' : 'text-gray-600'}`}>
                                                    {takenLeave}
                                                </td>

                                                {daysInMonth.map((day) => {
                                                    const isWeekend = day.isWeekend;
                                                    const currentValue = getValue(person, day.date);
                                                    const isDarkened = darkenedDays[`${year}-${month}-${day.date}`];
                                                    const isOverseas = overseasData[`${year}-${month}-${day.date}-${person}`];
                                                    
                                                    // Disable if Global Lock OR Individual Lock
                                                    const isDisabled = isLocked || isMemberLocked;

                                                    return (
                                                        <td 
                                                            key={`${person}-${day.date}`} 
                                                            className={`
                                                                border-r border-b border-gray-200 p-0 relative
                                                                ${isDarkened 
                                                                    ? 'bg-gray-200' 
                                                                    : (isOverseas 
                                                                        ? 'bg-pink-100' 
                                                                        : (isWeekend ? 'bg-orange-50/30' : 'bg-white')
                                                                      )
                                                                }
                                                                ${isMemberLocked && !isDarkened ? 'bg-gray-50' : ''}
                                                            `}
                                                        >
                                                            <select
                                                                disabled={isDisabled}
                                                                value={currentValue}
                                                                onChange={(e) => handleInputChange(person, day.date, e.target.value)}
                                                                className={getSelectStyle(currentValue)}
                                                                style={{ textAlignLast: 'center' }}
                                                            >
                                                                {OPTIONS.map(opt => (
                                                                    <option key={opt} value={opt}>
                                                                        {opt === '' ? '' : opt}
                                                                    </option>
                                                                ))}
                                                            </select>
                                                            <div className="absolute right-0 top-0 bottom-0 w-2 pointer-events-none opacity-0 group-hover/td:opacity-30"></div>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                            );
                                        })}

                                        {/* Statistics Row 1: 上班人數 */}
                                        <tr className="bg-gray-100 font-bold border-t-2 border-gray-300">
                                            {/* Spacer for Name and Taken cols */}
                                            <td className="sticky left-0 z-10 bg-gray-100 border-r border-b border-gray-300 text-gray-700 text-center shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] px-2 h-10">
                                                上班人數
                                            </td>
                                            <td className="sticky left-[120px] z-10 bg-gray-100 border-r border-b border-gray-300 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)]"></td>

                                            {daysInMonth.map((day) => {
                                                const count = getWorkingCount(day.date);
                                                const reqStaff = getRequiredStaff(day.date, day.isWeekend);
                                                const isShortage = count < reqStaff;
                                                const isDarkened = darkenedDays[`${year}-${month}-${day.date}`];
                                                
                                                return (
                                                    <td 
                                                        key={`stats-${day.date}`}
                                                        className={`
                                                            text-center border-r border-b border-gray-300 h-10
                                                            ${isDarkened ? 'bg-gray-200 border-gray-300' : ''}
                                                            ${isShortage ? 'text-red-600 ' + (isDarkened ? '' : 'bg-red-50') : 'text-green-700'}
                                                        `}
                                                    >
                                                        {count}
                                                    </td>
                                                );
                                            })}
                                        </tr>

                                        {/* Statistics Row 2: 可休人數 (上班 - 需求) */}
                                        <tr className="bg-gray-50 font-bold border-t border-gray-200">
                                            {/* Spacer for Name and Taken cols */}
                                            <td className="sticky left-0 z-10 bg-gray-50 border-r border-b border-gray-300 text-gray-700 text-center shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] px-2 h-10">
                                                可休人數
                                            </td>
                                            <td className="sticky left-[120px] z-10 bg-gray-50 border-r border-b border-gray-300 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)]"></td>

                                            {daysInMonth.map((day) => {
                                                const count = getWorkingCount(day.date);
                                                const reqStaff = getRequiredStaff(day.date, day.isWeekend);
                                                const available = count - reqStaff;
                                                const isDarkened = darkenedDays[`${year}-${month}-${day.date}`];
                                                
                                                // 顏色邏輯：正數(藍色)表示有多餘人力，負數(紅色)表示缺人
                                                let textColor = 'text-gray-400';
                                                if (available > 0) textColor = 'text-blue-600';
                                                if (available < 0) textColor = 'text-red-600';

                                                return (
                                                    <td 
                                                        key={`available-${day.date}`}
                                                        className={`
                                                            text-center border-r border-b border-gray-300 h-10 ${textColor}
                                                            ${isDarkened ? 'bg-gray-200 border-gray-300' : ''}
                                                        `}
                                                    >
                                                        {available}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="bg-white border-t border-gray-200 px-6 py-2 text-xs text-gray-500 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            {syncStatus === 'syncing' && <span className="flex items-center text-blue-600"><Cloud size={12} className="mr-1 animate-pulse"/> 同步中...</span>}
                            {syncStatus === 'saved' && <span className="flex items-center text-green-600"><Cloud size={12} className="mr-1"/> 已儲存至雲端</span>}
                            {syncStatus === 'error' && <span className="flex items-center text-red-600"><CloudOff size={12} className="mr-1"/> 連線異常</span>}
                            {lastUpdated && (
                                <span className="flex items-center text-gray-400 ml-2 pl-2 border-l border-gray-200">
                                    <Clock size={12} className="mr-1"/> 最後更新：{formatLastUpdated(lastUpdated)}
                                </span>
                            )}
                        </div>
                        <div>
                            Vibe Coding 製作
                        </div>
                    </footer>

                    {/* Help Modal */}
                    <Modal
                        isOpen={showHelpModal}
                        onClose={() => setShowHelpModal(false)}
                        title="使用說明"
                    >
                        <div className="flex flex-col gap-4">
                            <div className="bg-amber-50 border border-amber-200 rounded-md p-4">
                                <h4 className="font-bold text-amber-800 mb-2 flex items-center gap-2">
                                    <Lock size={16} /> 個人班表鎖定功能
                                </h4>
                                <p className="text-sm text-amber-900 leading-relaxed">
                                    排完自己的班表可以按鎖定🔒，並設定密碼，沒有解鎖其他人不能更改你的班表。
                                </p>
                            </div>
                            
                            <div className="text-sm text-gray-600 space-y-2">
                                <p className="font-bold text-gray-700">其他功能提示：</p>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li>點擊標題旁的 <Plane size={14} className="inline"/> 可預排「出國日期」，該日期將顯示粉紅色底色。</li>
                                    <li>點擊標題旁的 <Settings size={14} className="inline"/> 可新增/刪除排班人員。</li>
                                    <li>雙擊日期標題可將該欄位標記底色。</li>
                                    <li>「已休」欄位自動計算「休」與「休播」的總天數。</li>
                                </ul>
                            </div>

                            <div className="flex justify-end mt-2">
                                <button 
                                    onClick={() => setShowHelpModal(false)}
                                    className="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
                                >
                                    知道了
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Overseas Modal */}
                    <Modal 
                        isOpen={showOverseasModal} 
                        onClose={() => setShowOverseasModal(false)} 
                        title="預排出國日期"
                    >
                        <div className="flex flex-col gap-4">
                            <div className="flex flex-col gap-1">
                                <label className="text-sm font-bold text-gray-700">人員</label>
                                <select 
                                    value={overseasPerson} 
                                    onChange={(e) => setOverseasPerson(e.target.value)}
                                    className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    {staffList.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                            
                            <div className="flex gap-2">
                                <div className="flex-1 flex flex-col gap-1">
                                    <label className="text-sm font-bold text-gray-700">開始日期</label>
                                    <input 
                                        type="date" 
                                        value={overseasStartDate}
                                        onChange={(e) => setOverseasStartDate(e.target.value)}
                                        className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    />
                                </div>
                                <div className="flex-1 flex flex-col gap-1">
                                    <label className="text-sm font-bold text-gray-700">結束日期</label>
                                    <input 
                                        type="date" 
                                        value={overseasEndDate}
                                        onChange={(e) => setOverseasEndDate(e.target.value)}
                                        className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    />
                                </div>
                            </div>

                            <div className="flex justify-end gap-2 mt-4">
                                <button 
                                    onClick={() => handleSaveOverseas(false)}
                                    className="px-4 py-2 text-sm text-red-600 bg-red-50 hover:bg-red-100 rounded-md transition-colors"
                                >
                                    清除標記
                                </button>
                                <button 
                                    onClick={() => handleSaveOverseas(true)}
                                    className="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors font-medium"
                                >
                                    新增標記
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Global Unlock Modal */}
                    <Modal 
                        isOpen={showUnlockModal} 
                        onClose={() => setShowUnlockModal(false)} 
                        title={`解鎖 ${year}年${month}月 資料`}
                    >
                        <div className="flex flex-col gap-4">
                            <p className="text-sm text-gray-600">請輸入管理員密碼以繼續編輯：</p>
                            <input 
                                type="password" 
                                value={unlockPassword}
                                onChange={(e) => {
                                    setUnlockPassword(e.target.value);
                                    setUnlockError('');
                                }}
                                onKeyDown={(e) => e.key === 'Enter' && confirmUnlock()}
                                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="輸入密碼..."
                                autoFocus
                            />
                            {unlockError && <p className="text-xs text-red-500 font-bold">{unlockError}</p>}
                            <div className="flex justify-end gap-2 mt-2">
                                <button 
                                    onClick={() => setShowUnlockModal(false)}
                                    className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                                >
                                    取消
                                </button>
                                <button 
                                    onClick={confirmUnlock}
                                    className="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors font-medium"
                                >
                                    確認解鎖
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Member Lock Modal */}
                    <Modal 
                        isOpen={showMemberLockModal} 
                        onClose={() => setShowMemberLockModal(false)} 
                        title={isSettingLock ? `鎖定成員：${targetMember}` : `解鎖成員：${targetMember}`}
                    >
                        <div className="flex flex-col gap-4">
                            <p className="text-sm text-gray-600">
                                {isSettingLock 
                                    ? "請設定一組密碼來鎖定此成員的班表：" 
                                    : "輸入你設定的密碼解鎖"}
                            </p>
                            <input 
                                type="password" 
                                value={memberLockPassword}
                                onChange={(e) => {
                                    setMemberLockPassword(e.target.value);
                                    setUnlockError('');
                                }}
                                onKeyDown={(e) => e.key === 'Enter' && confirmMemberLockAction()}
                                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="輸入密碼..."
                                autoFocus
                            />
                            {unlockError && <p className="text-xs text-red-500 font-bold">{unlockError}</p>}
                            <div className="flex justify-end gap-2 mt-2">
                                <button 
                                    onClick={() => setShowMemberLockModal(false)}
                                    className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                                >
                                    取消
                                </button>
                                <button 
                                    onClick={confirmMemberLockAction}
                                    className={`px-4 py-2 text-sm text-white rounded-md transition-colors font-medium ${isSettingLock ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}
                                >
                                    {isSettingLock ? "確認鎖定" : "確認解鎖"}
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Staff Auth Modal */}
                    <Modal 
                        isOpen={showStaffAuthModal} 
                        onClose={() => setShowStaffAuthModal(false)} 
                        title="驗證身份"
                    >
                        <div className="flex flex-col gap-4">
                            <p className="text-sm text-gray-600">請輸入管理員密碼以管理人員：</p>
                            <input 
                                type="password" 
                                value={staffAuthPassword}
                                onChange={(e) => {
                                    setStaffAuthPassword(e.target.value);
                                    setStaffAuthError('');
                                }}
                                onKeyDown={(e) => e.key === 'Enter' && confirmStaffAuth()}
                                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="輸入密碼..."
                                autoFocus
                            />
                            {staffAuthError && <p className="text-xs text-red-500 font-bold">{staffAuthError}</p>}
                            <div className="flex justify-end gap-2 mt-2">
                                <button 
                                    onClick={() => setShowStaffAuthModal(false)}
                                    className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                                >
                                    取消
                                </button>
                                <button 
                                    onClick={confirmStaffAuth}
                                    className="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors font-medium"
                                >
                                    確認
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Staff Manager Modal */}
                    <Modal 
                        isOpen={showStaffManagerModal} 
                        onClose={() => setShowStaffManagerModal(false)} 
                        title="管理排班人員"
                    >
                        <div className="flex flex-col gap-4">
                            <p className="text-xs text-gray-500 mb-1">
                                💡 提示：按住左側圖示可拖曳排序，點擊右側垃圾桶刪除。
                            </p>
                            <div className="max-h-60 overflow-y-auto border rounded-md divide-y bg-white">
                                {staffList.map((person, index) => (
                                    <div 
                                        key={index} 
                                        draggable
                                        onDragStart={(e) => handleDragStart(e, index)}
                                        onDragOver={(e) => handleDragOver(e, index)}
                                        onDrop={(e) => handleDrop(e, index)}
                                        className={`flex items-center justify-between p-2 hover:bg-gray-50 transition-colors ${draggedIndex === index ? 'opacity-50 bg-gray-100' : 'cursor-move'}`}
                                    >
                                        <div className="flex items-center gap-2">
                                            <GripVertical size={16} className="text-gray-400 cursor-grab active:cursor-grabbing" />
                                            <span className="w-6 h-6 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-xs font-bold select-none">
                                                {person.charAt(0)}
                                            </span>
                                            <span className="text-sm font-medium select-none">{person}</span>
                                        </div>
                                        <button 
                                            onClick={() => handleRemoveStaff(index)}
                                            className="text-red-500 hover:text-red-700 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                            title="刪除"
                                        >
                                            <Minus size={16} />
                                        </button>
                                    </div>
                                ))}
                                {staffList.length === 0 && <div className="p-4 text-center text-gray-400 text-sm">暫無人員</div>}
                            </div>
                            
                            <div className="flex items-center gap-2 border-t pt-4">
                                <input 
                                    type="text" 
                                    value={newStaffName}
                                    onChange={(e) => setNewStaffName(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleAddStaff()}
                                    className="flex-1 px-3 py-2 border rounded-md text-sm focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-500/20"
                                    placeholder="輸入新人員姓名..."
                                />
                                <button 
                                    onClick={handleAddStaff}
                                    className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center shadow-sm"
                                >
                                    <Plus size={20} />
                                </button>
                            </div>

                            <div className="flex justify-end gap-2 mt-2">
                                <button 
                                    onClick={() => setShowStaffManagerModal(false)}
                                    className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                                >
                                    完成
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Clear Confirmation Modal */}
                    <Modal 
                        isOpen={showClearModal} 
                        onClose={() => setShowClearModal(false)} 
                        title="確認清空"
                    >
                        <div className="flex flex-col gap-4">
                            <div className="flex items-center gap-3 text-red-600 bg-red-50 p-3 rounded-md">
                                <AlertTriangle size={24} />
                                <span className="font-bold text-sm">警告：此動作無法復原！</span>
                            </div>
                            <p className="text-sm text-gray-700 leading-relaxed">
                                您確定要清空 <span className="font-bold">{year}年{month}月</span> 的所有排班資料嗎？
                            </p>
                            <div className="flex justify-end gap-2 mt-2">
                                <button 
                                    onClick={() => setShowClearModal(false)}
                                    className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                                >
                                    取消
                                </button>
                                <button 
                                    onClick={confirmClearMonth}
                                    className="px-4 py-2 text-sm text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors font-medium"
                                >
                                    確認清空
                                </button>
                            </div>
                        </div>
                    </Modal>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<PoliticalGroupSchedule />);
    </script>
</body>
</html>